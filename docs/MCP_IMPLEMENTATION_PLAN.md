# MCP服务完整实现计划

## 项目概述

本计划旨在将现有的简化版MCP服务升级为完整的MCP (Model Context Protocol) 服务实现，支持大模型自主调用工具、多轮思考决策，并在用户界面上提供透明的思考过程展示。

## 现状分析

### 当前MCP实现状况
- ✅ **基础架构**: 简化版MCP协议，支持基本的请求/响应
- ✅ **文档解析服务**: 功能完整的DocumentParserService
- ❌ **工具自动调用**: 缺失LLM主动调用工具的能力
- ❌ **多轮对话管理**: 无法支持思考-调用-再思考的循环
- ❌ **流式思考过程**: UI无法显示中间思考过程

### 技术债务
- `file_operations.py` 存在语法错误需要修复
- 当前MCP实现过于简化，不支持标准MCP协议特性
- 缺少工具发现和注册机制

## 技术选型

### MCP协议实现
- **主要包**: `mcp` (官方MCP Python包)
- **备选方案**: 自实现符合MCP标准的协议层
- **WebSocket支持**: `websockets` 用于实时通信
- **JSON-RPC**: `jsonrpclib-pelix` 用于标准化RPC通信

### Agent思考框架
- **思考引擎**: 自实现基于Chain-of-Thought的思考循环
- **工具调用决策**: Function Calling + 自定义决策逻辑
- **状态管理**: 基于状态机的对话流程管理

### UI交互组件
- **流式输出**: Streamlit的`st.write_stream()` 
- **实时更新**: `st.empty()` + `st.rerun()`
- **折叠面板**: `st.expander()` 用于思考过程展示
- **进度指示**: `st.progress()` 和 `st.spinner()`

## 架构设计

### 1. MCP服务器架构

```
MCP服务层
├── MCPServer (真正的MCP服务器)
│   ├── 工具注册与发现
│   ├── 会话管理
│   └── 标准MCP协议支持
├── 工具定义层
│   ├── DocumentTools (文档处理工具)
│   ├── AnalysisTools (数据分析工具)
│   ├── FileTools (文件操作工具)
│   └── WebTools (网络搜索工具)
└── 工具执行层
    ├── 安全沙箱
    ├── 权限控制
    └── 结果验证
```

### 2. 智能决策引擎

```
智能决策引擎
├── ThinkingAgent (思考智能体)
│   ├── 问题分析
│   ├── 工具选择决策
│   ├── 执行计划生成
│   └── 结果评估
├── WorkflowManager (工作流管理)
│   ├── 任务分解
│   ├── 并行执行控制
│   ├── 错误处理与重试
│   └── 状态持久化
└── ConversationManager (对话管理)
    ├── 多轮对话历史
    ├── 上下文管理
    ├── 记忆机制
    └── 流式输出控制
```

### 3. UI展示层架构

```
UI展示层
├── ChatInterface (主聊天界面)
│   ├── 问题输入区
│   ├── 思考过程展示区
│   ├── 工具调用状态区
│   └── 最终答案区
├── StreamingOutput (流式输出组件)
│   ├── 实时文本流
│   ├── 代码块高亮
│   └── 表格数据展示
└── ProcessVisualizer (过程可视化)
    ├── 思考步骤树
    ├── 工具调用链
    └── 执行时间统计
```