### 五步实施计划（基于《实现清单.md》）

### 第1步：架构对齐与契约制定（角色/流程/Schema）

- 目标：确定多智能体角色与工作流编排方式，锁定输入输出与引用规范。
- 范围：
  - 明确 4 角色：`Router`、`Retriever`、`Analyst`、`Critic`（`Toolsmith` 暂缓）。
  - 统一结果结构：结论段、证据表（含片段ID/来源/时间）、不确定性说明。
  - 工作流编排图：从上传→解析→检索→分析→审校→整合。
- 关键改动点：
  - `workflows/document_workflow.py`：梳理步骤与依赖；修复 `set_execution_order(...)` 缺参问题。
  - `config/settings.py`：为各 Agent 增加 prompt 模板占位符与开关。
  - 约定 MCP 方法命名与 I/O（先用现有 `DocumentParserService`，记录后续 `FileOperationsService`/vdb/search 的计划契约）。
- 交付：
  - 流程图/步骤清单、I/O JSON Schema、引用规范说明。
- 验收标准：
  - 所有角色职责清晰、步骤依赖明确、结果字段在团队内达成一致。

### 第2步：最小可用多智能体链路（Router → Retriever → Analyst → QA）

- 目标：在不大改底座的前提下，先跑通“多智能体协作”的最小闭环。
- 范围：
  - 新增 `RouterAgent`（意图/预算/是否需要检索的决策）。
  - `Retriever` 利用现有 `utils/rag_utils.py` 实现检索与重排（先不强制抽象为 MCP Server）。
  - `Analyst` 输出结构化证据表与草稿结论；`QAAgent` 作为回答口径整合与成文。
  - 工作流步骤：`document_parsing` → `text_extraction` → `retrieval` → `analysis` → `question_answering` → `result_integration`。
- 关键改动点：
  - `agents/`：新增 `router_agent.py`、`retriever_agent.py`，复用 `analysis_agent.py`、`qa_agent.py`。
  - `app.py`：注册新智能体到 `agent_coordinator`。
  - `workflows/document_workflow.py`：补齐步骤与依赖、上下文传递（不并发，先串行稳定）。
- 交付：
  - 可在 UI/CLI 跑通一次端到端请求，输出带引用的回答。
- 验收标准：
  - 至少包含 3 段证据、回答中含引用标注；失败有可读错误信息；无阻塞性异常。

### 第3步：加入 Critic 与质量保障（审校/一致性/不确定性）

- 目标：引入事实核对与引用完整性检查，提升答案可信度。
- 范围：
  - 新增 `CriticAgent`：对 `Analyst` 产物与 `Retriever` 证据做一致性/覆盖率校验，产出“不确定性说明”和改进建议。
  - `result_integration` 汇总并打分（置信度/证据覆盖率）。
  - 引入可配置的最小引用覆盖规则与失败降级策略。
- 关键改动点：
  - `agents/critic_agent.py`；`workflows/document_workflow.py` 增加 `verification/critic` 步骤与依赖。
  - `config/settings.py`：增加阈值与开关。
- 交付：
  - 回答附带置信度、未覆盖风险提示；当证据不足时可选自动降级（提示用户补充）。
- 验收标准：
  - 随机抽样 10 例，错误事实率显著下降；引用缺失可被识别并提示。

### 第4步：MCP 工具化与并发优化（外部能力下沉到 MCP）

- 目标：把关键外部能力“工具化”，支持并发与可控访问。
- 范围：
  - 重新启用 `mcp_services/file_operations.py`，补齐读写/列目/受控下载。
  - 逐步封装 `mcp.vdb`、`mcp.search`（开始可由 `utils/rag_utils.py` 适配包装，之后独立服务化）。
  - 为检索与推理步骤引入并发（依赖 `BaseWorkflow` 的依赖图并发能力）。
  - 加入 `mcp.cache`（轻量内存/本地缓存起步）降低重复检索成本。
- 关键改动点：
  - `mcp_services/` 增量实现/适配；`workflows/document_workflow.py` 开启并行的可配置开关。
  - Agent 内调用外部能力统一走 `mcp_manager.handle_request(...)`。
- 交付：
  - 检索/文件访问走 MCP，具备基本配额/日志；检索链路支持并发。
- 验收标准：
  - 相同问题二次提问时延降低；并发开启后正确性不下降、无数据越权。

### 第5步：可运维与评测（观测/预算/回归）

- 目标：让系统可观测、可评测、可控成本。
- 范围：
  - 日志与指标：请求耗时、检索命中率、引用覆盖率、成本（tokens/$）。
  - 评测接口：`mcp.eval` 或离线评测脚本，对比多版本提示词/策略。
  - 预算守护：请求级与会话级上限，自动降级（减 top‑k、缩上下文、低成本模型先行）。
  - 基准集与回归用例。
- 关键改动点：
  - `utils/llm_utils.py` 与工作流收集指标；新增轻量评测脚本；配置预算策略。
- 交付：
  - 仪表化指标、评测报表、回归数据集与一键评测脚本。
- 验收标准：
  - 核心指标可视化；版本切换能量化比较；预算超限能被拦截或降级。

—

- 如你同意，我将从“第1步”开始落地：补全契约与执行顺序、确定各 Agent 的输入输出与字段命名，随后进入第2步实现最小可用链路。
